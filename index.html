<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text TV</title>
    <style>
      html,
      body {
        height: 98%;
        text-align: center;
        font-family: monospace;
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      main {
        flex: 1 1;
        overflow-y: auto;
        overflow-x: hidden;
      }
      article {
        white-space: pre;
        width: 40ch; /* Article has at most 40 characters per line */
        font-size: min(4cqw, 20px); /* Responsive font size when the viewport is narrow */
        line-height: 1.3;
        border-top: 1px solid;
      }
      footer {
        flex: 0 1;
        border-top: 1px solid;
      }
      #prev,
      #next {
        text-decoration: none;
        font-size: 30pt;
        padding: 0 10pt;
      }
      input {
        font-size: 20pt;
        text-align: inherit;
      }
      button {
        cursor: pointer;
        background: none;
        border: none;
        text-decoration: underline;
        padding: 0;
        font-family: inherit;
        font-size: inherit;
        color: blue;
      }
      button[data-page=""] {
        color: grey;
      }
      @media (prefers-color-scheme: dark) {
        body {
          background-color: black;
          color: white;
        }
        button {
          color: #00bfff;
        }
        select {
          color: white;
          background-color: black;
        }
      }
    </style>
    <script type="module">
      const main = document.getElementById("main"),
        prev = document.getElementById("prev"),
        next = document.getElementById("next"),
        home = document.getElementById("home"),
        input = document.getElementById("input"),
        providerSelect = document.getElementById("provider-select"),
        source = document.getElementById("source"),
        infoBtn = document.getElementById("info-btn"),
        infoModal = document.getElementById("info-modal"),
        corsProxy = window.atob("aHR0cHM6Ly90ZXh0dHYtcHJveHkuYWxiZXJ0LWQxZi53b3JrZXJzLmRldi8/dXJsPQo=");

      const fetchJsonFromUrl = async url => {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Sidan kunde inte hittas.");
        return res.json();
      };

      const providerSettings = {
        svt: {
          name: "SVT",
          defaultPage: "100",
          homePage: "100",
          getSourceUrl: page => `https://www.svt.se/text-tv/webb/${page}`,
          fetchPage: async page => {
            const json = await fetchJsonFromUrl(`https://www.svt.se/text-tv/api/${page}`);
            if (json.status === "fail") throw new Error("Sidan finns inte.");
            return {
              prev: json.data.prevPage,
              next: json.data.nextPage,
              html: json.data.subPages.map(p => `<article>${p.altText.trimEnd()}</article>`).join("")
            };
          }
        },
        yle: {
          name: "Yle",
          defaultPage: "700",
          homePage: "700",
          getSourceUrl: page => `https://yle.fi/tekstitv/txt/${page}_0001.htm`,
          fetchPage: async page => {
            const json = await fetchJsonFromUrl(`${corsProxy}https://yle.fi/aihe/yle-ttv/json?P=${page}_0001`);
            if (!json.data || !json.data.length) throw new Error("Sidan finns inte.");

            const pageData = json.data[0];
            const parser = new DOMParser();

            // Parse pagination
            const navDoc = parser.parseFromString(pageData.content.pagination, "text/html");
            const prevLink = navDoc.querySelector(".js-yle-ttv-prev-page");
            const nextLink = navDoc.querySelector(".js-yle-ttv-next-page");

            // Parse content
            const contentDoc = parser.parseFromString(pageData.content.text, "text/html");

            return {
              prev: prevLink?.dataset?.yleTtvPageName?.split("_")[0] || "",
              next: nextLink?.dataset?.yleTtvPageName?.split("_")[0] || "",
              html: `<article>${contentDoc.body.textContent || ""}</article>`
            };
          }
        }
      };

      let currentProvider = "svt";

      const pageButton = p => `<button data-page="${p}" aria-label="Gå till sida ${p}" title="Gå till sida ${p}">${p}</button>`;

      const loadPage = (page, provider, push = true) => {
        if (!page) return;

        // Update state
        currentProvider = provider;
        if (providerSelect.value !== provider) providerSelect.value = provider;

        // Handle URL update
        if (push) history.pushState({ page, provider }, "", `?provider=${provider}&page=${page}`);

        document.title = `Text TV ${page} (${providerSettings[provider].name})`;
        source.href = providerSettings[provider].getSourceUrl(page);
        input.value = page;
        providerSettings[provider]
          .fetchPage(page)
          .then(data => {
            prev.dataset.page = data.prev;
            next.dataset.page = data.next;
            return data.html;
          })
          .then(html => html.replace(/\b(\d{3})\b/g, pageButton))
          .catch(err => `Ett fel uppstod:<br />${err.message}`)
          .then(html => (main.innerHTML = html));
      };

      // Initial load based on the current URL
      const params = new URL(window.location.href).searchParams;
      const initialProvider = params.get("provider") || "svt";
      const initialPage = params.get("page") || providerSettings[initialProvider].defaultPage;

      // Validate provider exists, fallback to svt
      currentProvider = providerSettings[initialProvider] ? initialProvider : "svt";
      loadPage(initialPage, currentProvider, false);

      // Provider switch
      providerSelect.addEventListener("change", e => {
        const newProvider = e.target.value;
        const page = providerSettings[newProvider].defaultPage; // Reset to default page when switching provider
        loadPage(page, newProvider);
      });

      // Navigation clicks
      [prev, next, main].forEach(el =>
        el.addEventListener("click", e => (e.preventDefault(), loadPage(e.target?.dataset?.page, currentProvider)))
      );

      // Home button
      home.addEventListener("click", e => {
        e.preventDefault();
        loadPage(providerSettings[currentProvider].homePage, currentProvider);
      });

      // Manual input
      input.addEventListener("change", e => loadPage(e.target?.value, currentProvider));

      // Handle back/forward navigation.
      window.addEventListener("popstate", e => {
        const p = e.state?.page || providerSettings["svt"].defaultPage;
        loadPage(p, e.state?.provider || "svt", false);
      });

      // Keyboard navigation (Arrow keys, wasd, jkl, home, info).
      // prettier-ignore
      const keyToLink = { ArrowLeft: prev, ArrowRight: next, j: prev, l: next, a: prev, d: next,
                          i: infoBtn, Home: home, h: home, s: home, k: home};
      document.addEventListener("keydown", e => {
        if (document.activeElement === input) return; // Ignore if input is focused
        if (keyToLink[e.key]) keyToLink[e.key].click();
        if (e.key === "e") {
          e.preventDefault(); // Prevent default action for 'e' key
          input.focus();
          input.select();
        }
      });

      // Modal for info button
      infoBtn.addEventListener("click", () => infoModal.showModal());
      infoModal.addEventListener("click", e => (e.target === infoModal ? infoModal.close() : null));
    </script>
  </head>
  <body>
    <main id="main"></main>
    <footer>
      <nav>
        <div>
          <button id="prev" data-page="" aria-label="Förra sidan" title="Förra sidan">&larr;</button>
          <input id="input" type="text" inputmode="numeric" size="3" minlength="3" maxlength="3" />
          <button id="next" data-page="" aria-label="Nästa sida" title="Nästa sida">&rarr;</button>
        </div>
      </nav>
      <div style="display: flex; gap: 10px; position: absolute; bottom: 10px; left: 10px">
        <button id="home" aria-label="Hem" title="Hem">Hem</button>
        <select id="provider-select" aria-label="Välj källa">
          <option value="svt">SVT</option>
          <option value="yle">Yle</option>
        </select>
        <p><a id="source" href="#" target="_blank">Källa</a></p>
      </div>

      <div style="display: flex; gap: 10px; position: absolute; bottom: 10px; right: 10px">
        <button id="info-btn">Info</button>
      </div>
    </footer>
    <dialog id="info-modal">
      <form method="dialog"><button style="float: right">X</button></form>
      <h3>Om Webbsidan</h3>
      <p>Text TV är en tjänst från SVT och Yle.</p>
      <p>Denna sida är inte officiell och detta är <a href="https://github.com/albertaillet/texttv" target="_blank">koden</a>.</p>
      <p>Tangentbordskommandon:</p>
      <p>[&larr;], [A] eller [J] för förra sidan</p>
      <p>[&rarr;], [D] eller [L] för nästa sida</p>
      <p>[Home], [H], [K] eller [S] för startsidan</p>
      <p>[E] för att ändra sidan</p>
      <p>[I] för att öppna denna dialog</p>
    </dialog>
  </body>
</html>
